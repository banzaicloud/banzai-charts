{{- $root := . }}
{{- if and .Values.compact.enabled .Values.compact.persistentVolumeClaim }}
{{- $pvc := .Values.compact.persistentVolumeClaim -}}

{{- $shards := int 0 }}

{{- if .Values.compact.hashPartitioning }}
  {{- $shards = int .Values.compact.hashPartitioning.shards }}
{{- end }}

{{- range $index, $_ := until $shards }}
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: {{ $pvc.name }}-{{ $index }}
  labels:
    app.kubernetes.io/name: {{ include "thanos.name" $root }}
    helm.sh/chart: {{ include "thanos.chart" $root }}
    app.kubernetes.io/instance: {{ $root.Release.Name }}
    app.kubernetes.io/managed-by: {{ $root.Release.Service }}
    app.kubernetes.io/version: {{ $root.Chart.AppVersion | replace "+" "_" }}
    app.kubernetes.io/component: compact
{{ with $root.Values.compact.deploymentLabels }}{{ toYaml . | indent 4 }}{{ end -}}
  {{- with $root.Values.compact.deploymentAnnotations }}
  annotations: {{ toYaml . | nindent 4 }}
  {{- end }}
spec:
  {{- toYaml $pvc.spec | nindent 2 }}
---
{{- end }}
{{- end }}
